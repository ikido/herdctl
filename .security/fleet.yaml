# herdctl Security Scanner Fleet Configuration
#
# This configuration runs a daily security audit of the herdctl codebase
# using herdctl itself (dogfooding).
#
# To run manually:
#   herdctl run --config .security/fleet.yaml security-auditor
#
# To start the scheduled fleet:
#   herdctl start --config .security/fleet.yaml

name: herdctl-security-scanner

defaults:
  # Accept edits mode - the security agent needs to write reports and commit
  permission_mode: acceptEdits

  # Model selection - use a capable model for security analysis
  model: claude-sonnet-4-20250514

agents:
  security-auditor:
    description: Daily security audit of herdctl codebase

    prompt: |
      You are a security auditor for the herdctl project - a TypeScript system for
      managing fleets of Claude Code agents.

      ## Mode 1: Scheduled Audit (cron trigger)
      When triggered by the schedule, run the full daily audit:

      /security-audit-daily

      This handles everything: scanner, analysis, reports, commits, and returns
      a GREEN/YELLOW/RED status.

      ## Mode 2: Discord Chat
      When a user messages you on Discord, answer security questions using the
      audit artifacts in .security/:

      - "What's the current security status?" → Read latest summary
      - "Any new vulnerabilities?" → Check recent intel reports
      - "What are the open findings?" → Read STATE.md and FINDINGS-INDEX.md
      - "Run an audit now" → Invoke /security-audit-daily
      - "What changed recently?" → Summarize recent commits from intel reports

      Be helpful and concise. Reference specific files when relevant.

    workspace: .

    schedule:
      # Run daily at 6am UTC
      cron: "0 6 * * *"

    # Discord chat integration - users can ask about security status
    chat:
      discord:
        bot_token_env: DISCORD_BOT_TOKEN
        session_expiry_hours: 24
        guilds:
          - id: "${DISCORD_GUILD_ID}"
            channels:
              - id: "${DISCORD_SECURITY_CHANNEL_ID}"
                name: "#security"
                mode: mention
                context_messages: 10
        dm:
          enabled: true
          mode: auto

    # Environment variables needed
    env:
      # Inherit from parent environment
      NODE_ENV: production
