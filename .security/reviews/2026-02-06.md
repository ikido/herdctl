# Security Audit Review - 2026-02-06

**Audit Reviewed**: `.security/intel/2026-02-06.md`
**Review Date**: 2026-02-06

## Overall Assessment

**Coverage**: Adequate
**Depth**: Adequate
**Documentation**: Good
**Overall Grade**: B-

## Summary

The audit successfully verified hot spots that were modified (5 of 6 critical files) and thoroughly answered Q2 (path traversal vectors). However, it failed to check 3 critical hot spots that weren't modified (container-runner.ts, interpolate.ts, shell.ts), demonstrating that the audit only verifies *changed* files rather than *all* critical files. The investigation of Q2 was deep and thorough, but no creative attack ideation was performed, and assumptions about container isolation were repeated without verification.

## Gaps Identified

### Critical Gaps

1. **3 Critical Hot Spots Not Verified**
   - `container-runner.ts` - Has open Finding #009 (shell escaping), not verified
   - `interpolate.ts` - Critical for security, not mentioned
   - `shell.ts` - Executes shell commands, not mentioned
   - The hot-spot-verifier only checked files flagged by change-analyzer

2. **Selective Question Investigation**
   - Only Q2 was investigated (1 of 7 open questions)
   - Q8 (SDK wrapper escaping) is related to #009 but wasn't investigated alongside

### Medium Gaps

3. **No New Questions Added**
   - Discovered job-executor.ts:183 and job-output.ts:62 construct paths
   - Neither file was added to hot spots or flagged for future monitoring
   - Should have asked: "Does job-executor.ts need buildSafeFilePath?"

4. **Assumptions Not Verified**
   - "Container isolation mitigates risk" - repeated without verification
   - No Docker capability verification (could use `docker inspect`)

5. **No Attack Ideation**
   - No exploration of unicode/encoding bypasses on AGENT_NAME_PATTERN
   - No symlink attack consideration for path safety
   - No race condition analysis

### Minor Gaps

6. **Vague Recommendations**
   - "Consider investigating Q1" is not actionable
   - Should specify what to look for and where

## Process Failures

The fundamental issue is that the `/security-audit` orchestrator spawns `hot-spot-verifier` with only **modified files** from `change-analyzer`, not **all critical hot spots**. This means:

- Hot spots are only checked when they change
- Unchanged critical code accumulates staleness
- Finding #009 in container-runner.ts was ignored because the file wasn't modified

**Root cause**: The audit process is optimized for incremental speed, not comprehensive coverage.

## Improvements Made

The following changes have been made based on this review:

### Files Updated

- [ ] `.claude/commands/security-audit.md` - Proposed changes below
- [x] `.security/HOT-SPOTS.md` - Added job-executor.ts and job-output.ts
- [x] `.security/CODEBASE-UNDERSTANDING.md` - Added new questions Q9-Q11

### Questions Added

- Q9: Does job-executor.ts need buildSafeFilePath for mkdir operations?
- Q10: Does AGENT_NAME_PATTERN handle unicode normalization attacks?
- Q11: Can symlinks be created in .herdctl/ to escape buildSafeFilePath?

## Proposed Process Improvements

### For `/security-audit` Command

The hot-spot-verifier should be spawned in two modes:

1. **Modified hot spots** (current behavior) - Deep verification of changed files
2. **Staleness check** (NEW) - Quick check that unchanged critical hot spots haven't regressed

Proposed addition to Phase 3:

```markdown
**Decision point 1a: Hot-spot-verifier (modified files)**

IF change-analyzer recommends "VERIFY" (Category 1 hot spot touches found):
- Spawn hot-spot-verifier with modified files (current behavior)

**Decision point 1b: Hot-spot-verifier (staleness check)**

ALWAYS spawn a second hot-spot-verifier instance with ALL critical hot spots from HOT-SPOTS.md that were NOT modified, using mode: "staleness-check"

This ensures every critical hot spot is verified every audit, even if unchanged.
```

### For HOT-SPOTS.md

Add staleness tracking:

```markdown
| File | Why Critical | Last Verified | Days Since |
|------|--------------|---------------|------------|
```

### For Future Audits

1. Always verify ALL 6 critical hot spots, not just modified ones
2. Investigate at least 2 open questions per audit (Q2 + one more)
3. Add discovered code paths to HOT-SPOTS.md
4. Verify claims about container isolation with actual Docker inspection
5. Perform 10 minutes of creative attack ideation after verification

## Recommendations for Next Audit

1. **MUST**: Verify container-runner.ts, interpolate.ts, and shell.ts (skipped this audit)
2. **MUST**: Investigate Q8 (SDK wrapper escaping) - related to skipped #009
3. **SHOULD**: Add staleness tracking to HOT-SPOTS.md
4. **SHOULD**: Run `docker inspect` on a test container to verify capability drops
5. **SHOULD**: Test AGENT_NAME_PATTERN with unicode edge cases

---

**Reviewer**: Claude (self-review of automated audit)
**Time Spent**: ~15 minutes
