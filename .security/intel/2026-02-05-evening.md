# Security Intelligence Report - 2026-02-05 (Evening Review)

**Review Type**: Follow-up / Post-fix verification
**Reviewer**: Claude (automated via /security-audit skill)
**Branch**: feature/security-scanner
**Commit**: 87b5de6

---

## Executive Summary

Second security review of the day. The path traversal fix from earlier is verified working (path-safety now PASS). Scanner improvements reduced false positives (env-handling now PASS). **Found one new technical debt item**: incomplete shell escaping in Docker prompt execution - low practical risk but should be fixed for defense in depth.

**Overall posture**: Improved. 9 findings total, all known/accepted. No new critical issues.

---

## Key Findings

### Technical Debt: Incomplete Shell Escaping in Docker Prompts

**Location**: `packages/core/src/runner/runtime/container-runner.ts:157-162`
**Severity**: Low (mitigated by container isolation)
**Status**: New - Technical Debt

When executing prompts via Docker CLI runtime, only `\` and `"` are escaped:

```typescript
const escapedPrompt = prompt.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
const claudeCommand = `cd /workspace && printf %s "${escapedPrompt}" | claude ...`;
```

Missing escapes for: `$`, `` ` ``, `!` (bash special characters).

**Attack scenario**: A malicious prompt containing `$(id)` would execute inside the container. However:
1. Container is already the security boundary - fleet authors control agent behavior
2. The command runs inside the isolated container, not on the host
3. The prompt would still be passed to Claude after substitution

**Recommendation**: For defense in depth, add complete escaping:
```typescript
const escapedPrompt = prompt
  .replace(/\\/g, '\\\\')
  .replace(/"/g, '\\"')
  .replace(/\$/g, '\\$')
  .replace(/`/g, '\\`')
  .replace(/!/g, '\\!');
```

**Priority**: Low - technical debt, not urgent

---

### Verified Fixed: Path Traversal Protection

**Location**: `packages/core/src/state/utils/path-safety.ts`
**Status**: Verified PASS

The `buildSafeFilePath()` utility and `AGENT_NAME_PATTERN` validation are working correctly. Scanner now reports 0 findings for path-safety.

---

### Accepted Risks (Unchanged)

| Finding | Status | Notes |
|---------|--------|-------|
| hostConfigOverride bypass | Accepted | Required for advanced Docker config |
| bypassPermissions in examples | Intentional | Demo purposes only |
| shell:true in hook runner | Accepted | Required for shell hook functionality |
| npm audit vulnerabilities | Tracked | Via Dependabot |

---

## Changes Since Last Review (Earlier Today)

| Commit | Description | Security Assessment |
|--------|-------------|---------------------|
| 87b5de6 | test: add coverage for path traversal | Security improvement |
| f9da2a6 | fix: add path traversal protection | Security fix |
| 2e9faf2 | fix: improve scanner accuracy | Reduced false positives |
| 26682ce | feat: add automated security scanning | Infrastructure |

**Summary**: All changes improved security posture.

---

## Trend Analysis

| Check | Previous (18:22) | Current (21:03) | Trend |
|-------|-----------------|-----------------|-------|
| npm-audit | WARN (1) | WARN (1) | ➡️ Stable |
| docker-config | FAIL (4) | FAIL (3) | ✅ Improved |
| permission-modes | FAIL (2) | WARN (1) | ✅ Improved |
| subprocess-patterns | WARN (4) | WARN (4) | ➡️ Stable |
| path-safety | FAIL (1) | PASS (0) | ✅ Fixed |
| env-handling | FAIL (3) | PASS (0) | ✅ Fixed |

**Summary**: 4 of 6 checks improved or stayed stable. No regressions.

---

## Attack Surface Assessment

No changes to attack surface since earlier review.

**Entry points**: Fleet config files (primary), CLI arguments (minimal)
**Trust boundaries**: Zod validation, Docker containers, buildSafeFilePath

---

## Recommendations (Priority Order)

1. **[Low]** Fix incomplete shell escaping in container-runner.ts (technical debt)
2. **[Future]** Consider webhook signature verification for GitHub work source
3. **[Future]** Add audit logging for sensitive operations

---

## Questions for Next Review

1. Is the shell escaping fix worth a commit, or should it wait for other container work?
2. Are there other places where prompts are embedded in shell commands?
3. Should we add a scanner check for incomplete shell escaping?

---

## Intelligence Notes

### Patterns Observed
- The team is responsive to security findings - path traversal was fixed same day
- Scanner improvements reduced noise significantly (env-handling false positives gone)
- Container isolation provides a good defense-in-depth layer

### Code Quality Observations
- The container-runner.ts escaping is functional but incomplete
- The fix is simple and low-risk
- This is a good example of defense-in-depth thinking

### Session IDs Investigation
- Investigated session_id usage in sessions.ts with `shell: true`
- Session IDs come from Claude SDK (UUIDs), not user input
- Even if malicious, the JSON files are in user's own project
- Risk is minimal - no action needed

---

## Session Statistics

- **Deterministic scan runtime**: 1.9 seconds
- **Analysis time**: ~10 minutes
- **New findings**: 1 (technical debt, low priority)
- **Resolved findings verified**: 2 (path-safety, env-handling)
- **Overall assessment**: Security posture improved

---

## Next Actions

- [ ] Consider fixing shell escaping (low priority)
- [ ] Schedule next review after any significant changes
- [ ] Test /security-audit skill with herdctl scheduler
