# Security Intelligence Report - 2026-02-05

**Review Type**: Initial baseline + vulnerability fix
**Reviewer**: Claude (with Ed)
**Branch**: feature/security-scanner

---

## Executive Summary

First security review of herdctl codebase. Established deterministic scanning
infrastructure and **discovered and fixed a real path traversal vulnerability**
in agent name handling. 8 findings total, 1 already fixed, 2 accepted risks,
5 need attention.

---

## Key Findings

### üî¥ HIGH: Path Traversal via Agent Names (FIXED)

**Location**: `packages/core/src/state/session.ts`, `job-metadata.ts`
**Status**: ‚úÖ Fixed this session

Agent names from config were used directly in file paths without validation.
A name like `../../../tmp/evil` could write files outside `.herdctl/`.

**Attack scenario**: Malicious fleet config ‚Üí arbitrary file write ‚Üí potential
privilege escalation or data exfiltration.

**Fix applied**:
- Added `AGENT_NAME_PATTERN` regex to schema validation
- Created `buildSafeFilePath()` utility for defense-in-depth
- 75 tests added to verify the fix

**Deep dive**: [findings/001-path-traversal-agent-names.md](./findings/001-path-traversal-agent-names.md)

---

### üü° MEDIUM: Potential Secret Logging (NEEDS REVIEW)

**Locations**:
- `packages/cli/src/commands/init.ts:339` - "token" near log
- `examples/library-usage/error-handling.ts:443-444` - "api_key" near log

**Status**: üîç Manual review needed

Scanner detected sensitive-looking variable names near logging statements.
Could be false positives, but should verify no actual secrets are logged.

**Recommendation**: Read these specific lines and verify context.

---

### üü° MEDIUM: network:none Bug in Example

**Location**: `examples/runtime-showcase/agents/mixed-fleet.yaml:67`
**Status**: üêõ Bug to fix

Example config has `network: none` which will completely break Claude agents
(they need network access to call Anthropic API).

**Recommendation**: Change to `network: bridge` in the example.

---

### ‚ö†Ô∏è ACCEPTED: hostConfigOverride Bypass

**Location**: `packages/core/src/runner/runtime/container-manager.ts`
**Status**: Documented risk

This option can bypass all Docker security hardening. Required for advanced
configurations but could be dangerous if exposed to untrusted input.

**Mitigations in place**:
- Only available at fleet level (not agent level)
- Documented in THREAT-MODEL.md
- Scanner flags all usages

---

### ‚ö†Ô∏è ACCEPTED: Shell Hooks with shell:true

**Location**: `packages/core/src/hooks/runners/shell.ts`
**Status**: Documented risk

Shell hooks require `shell: true` for execution. This is inherent to the
feature, not a bug. Users control their own hook configuration.

---

## Changes Since Last Review

N/A - This is the first review.

---

## Trend Analysis

N/A - Baseline established. Future reviews will track trends.

**Current baseline**:
| Check | Findings |
|-------|----------|
| npm-audit | 2 moderate vulnerabilities |
| docker-config | 4 findings (3 hostConfigOverride, 1 network:none bug) |
| permission-modes | 2 findings (expected in examples) |
| subprocess-patterns | 4 findings (2 low, 2 medium) |
| path-safety | 0 findings (was 1, now fixed) |
| env-handling | 3 findings (potential secret logging) |

---

## Attack Surface Assessment

### Entry Points
1. **Configuration files** (fleet.yaml, agent configs) - PRIMARY
2. **GitHub webhooks** (if enabled) - UNKNOWN security status
3. **CLI arguments** - Minimal surface
4. **Environment variables** - Used for secrets, handled carefully

### Trust Boundaries
1. **Zod validation** - Primary defense for config input
2. **Docker containers** - Isolation for agent execution
3. **buildSafeFilePath** - Defense for state file paths

### Gaps Identified
1. Webhook signature verification - status unknown
2. Secret detection in logs - not implemented
3. Rate limiting - status unknown

---

## Recommendations (Priority Order)

1. **[Quick]** Fix the `network: none` bug in example config
2. **[Quick]** Review the potential secret logging findings manually
3. **[Medium]** Audit all other `path.join` usages for similar issues
4. **[Medium]** Implement secret detection/redaction in log output
5. **[Larger]** Verify webhook signature implementation

---

## Questions for Next Review

1. Are there other user-controlled strings that become file paths?
2. What is the actual implementation status of webhook signature verification?
3. Should we add automated secret detection to the scanner?

---

## Intelligence Notes

### Patterns Observed
- Job IDs had strict validation by accident; agent names didn't. This suggests
  a pattern: validate ALL identifiers that become paths, not just obvious ones.

### Code Quality Observations
- Security hardening in container-manager.ts is thorough (CapDrop, no-new-privs)
- The `hostConfigOverride` escape hatch is concerning but documented
- Zod validation is consistently used, which is good

### Architectural Insights
- The system treats config as "trusted after Zod validation" - this is reasonable
  but means Zod schemas are security-critical
- State directory is the main persistence surface; now hardened against traversal

---

## Session Statistics

- **Deterministic scan runtime**: 1.7 seconds
- **Analysis time**: ~45 minutes
- **Findings discovered**: 8
- **Findings fixed**: 1
- **Tests added**: 75
- **Documentation created**: This report + 4 supporting docs

---

## Next Actions

- [ ] Ed to review potential secret logging findings
- [ ] Fix network:none bug in example
- [ ] Schedule follow-up review after fixes
- [ ] Consider daily automated reviews once scheduler is tested
