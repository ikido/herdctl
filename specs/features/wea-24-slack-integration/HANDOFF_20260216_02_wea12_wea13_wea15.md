# Handoff: Slack Integration Bug Fixes (WEA-12, WEA-13, WEA-15)

## Summary

Fixed three bugs found during live testing of the Slack integration on the dev server. WEA-12 (channel messages without @mention) and WEA-13 (thread replies) were both caused by missing message event handling in the connector and a Slack app configuration issue. WEA-15 (all threads sharing one Claude session) was caused by a session fallback in `JobControl.trigger()` that auto-resumed the agent's last session for new threads.

## What Was Done

### WEA-12 & WEA-13: Message Handler Restructure (`packages/slack/src/slack-connector.ts`)
- Removed `if (!event.thread_ts) return;` guard that dropped all top-level channel messages
- Added top-level channel message routing via `channelAgentMap` — messages in configured channels now create threads and get responses
- Added thread reply routing: `activeThreads` (in-memory) → `sessionManager.getSession()` (survives restarts) → `channelAgentMap`
- Added @mention dedup guard: `message` handler skips messages containing `<@BOT_ID>` since `app_mention` handler already processes those
- Added debug logging at key decision points for production diagnostics

### WEA-13: Slack App Configuration Fix (not a code change)
- Root cause: Socket Mode was not delivering `message.channels` events despite the subscription appearing in the Slack API UI
- Fix: Toggle `message.channels` subscription off, save, re-add, save, reinstall the app
- This was diagnosed through 4 iterations of adding progressively deeper logging (handler → middleware → Bolt DEBUG), confirmed via Linear coordination with devops agent

### WEA-15: Per-Thread Session Isolation (`packages/core/`)
- Root cause: `JobControl.trigger()` has a fallback that calls `getSessionInfo()` to find the agent's last session when `resume` is `undefined`. SlackManager passed `undefined` for new threads, so every new thread inherited the previous thread's session
- Changed `TriggerOptions.resume` type from `string | undefined` to `string | null | undefined`:
  - `string` = resume this specific session
  - `null` = explicitly start fresh (new Slack thread)
  - `undefined` = use agent-level fallback (existing CLI/schedule behavior)
- `JobControl.trigger()` now skips the `getSessionInfo()` fallback when `resume === null`
- `SlackManager.handleMessage()` changed `existingSessionId` from `string | undefined` to `string | null` so new threads pass `null`

### Tests
- 17 new tests in `packages/slack/src/__tests__/slack-connector.test.ts` covering:
  - @mention routing (configured/unconfigured channels, in-thread mentions)
  - Thread reply routing via activeThreads and session manager recovery
  - Top-level channel message routing
  - @mention dedup (app_mention + message = exactly one event)
  - Bot message filtering (bot_id, bot_message subtype, own messages)
  - Message stats tracking
  - Reply function thread targeting
  - Event handler registration

### Diagnostic Code Cleanup
- Removed `LogLevel.DEBUG` from Bolt App constructor (was added for WEA-13 debugging)
- Removed global Bolt middleware (`app.use()`) that logged every event (was added for WEA-13 debugging)
- Removed info-level "Received message event" log at top of message handler (was added for WEA-13 debugging)

## What Worked

- **Linear-based coordination with devops agent** — commenting on issues with build/test instructions and getting test results back worked well for debugging a production issue without direct access to the Slack API dashboard
- **Iterative diagnostic approach** — progressively deeper logging (handler → middleware → Bolt DEBUG → Socket Mode WebSocket) isolated the root cause to the Slack app configuration level
- **Unit tests with mock Bolt app** — bypassing `connect()` and injecting a mock app via reflection allowed testing all handler logic without needing `@slack/bolt` as a test dependency

## What Didn't Work / Issues Found

- **`app.message()` vs `app.event("message")`** — Initial plan used `app.message()` per Bolt docs, but it silently drops thread replies in practice. Reverted to `app.event("message")` which works correctly
- **Socket Mode event subscription stale state** — `message.channels` appeared in the Slack API UI but Socket Mode didn't deliver the events. Toggling the subscription off/on and reinstalling fixed it. This is a Slack platform quirk with no obvious cause
- **Session fallback in JobControl** — The auto-resume fallback was invisible in logs because it logged at debug level. It took the devops agent's observation of "Found valid session for assistant: ..." appearing for new threads to identify the issue

## Key Learnings

- **Slack Socket Mode subscriptions can go stale** — even if `message.channels` shows in the Event Subscriptions UI, it may not actually be delivered via Socket Mode. Fix: remove, save, re-add, save, reinstall
- **`resume: undefined` vs `resume: null` semantic distinction** — in `TriggerOptions`, `undefined` means "I didn't specify, use your default behavior" while `null` means "I explicitly want no session". This pattern is useful for any option where the caller needs to distinguish "not specified" from "explicitly none"
- **Slack sends both `app_mention` and `message` events for @mentions** — the message handler must check `isBotMentioned()` and skip to avoid double processing

## Current State

- **Branch**: `feautres/specs/features/001-slack-integration`
- **Commits**: `d2343ae` (WEA-12/13), `81c4f57` (WEA-15)
- **Quality gates**: `pnpm typecheck`, `pnpm test` (2348 core + 330 slack tests pass), `pnpm build` all pass
- **WEA-12**: Done (confirmed by devops)
- **WEA-13**: Done (confirmed by devops after Slack app subscription toggle)
- **WEA-15**: In Progress — code fix committed, tarballs deployed to `devops-config/herdctl/tarballs/`, awaiting devops rebuild and test
- **Tarballs updated**: Both `herdctl-core-3.0.2.tgz` and `herdctl-slack-0.1.0.tgz` in `~/devops-config/herdctl/tarballs/`

## Next Steps

1. **Wait for WEA-15 test results** from devops agent — verify different threads get different session IDs
2. **Remove diagnostic code from production** — the `LogLevel.DEBUG` and middleware are already removed in the commit, but need rebuild to take effect
3. **Push branch and create PR** to upstream `edspencer/herdctl` (PR #46 was closed earlier, need a new one)
4. **Consider**: README for the slack package, docs site updates

## Relevant Files

### Modified in this session
- `packages/slack/src/slack-connector.ts` — message handler restructure (WEA-12/13), diagnostic cleanup
- `packages/slack/src/__tests__/slack-connector.test.ts` — new file, 17 connector tests
- `packages/core/src/fleet-manager/job-control.ts` — `resume: null` sentinel (WEA-15)
- `packages/core/src/fleet-manager/types.ts` — `TriggerOptions.resume` type change (WEA-15)
- `packages/core/src/fleet-manager/slack-manager.ts` — `existingSessionId` type change (WEA-15)
- `specs/features/001-slack-integration/DEPLOYMENT_NOTES.md` — new file, deployment docs
- `specs/features/001-slack-integration/001-slack-integration.md` — status update
- `specs/features/001-slack-integration/HANDOFF_20260215_01_slack_integration.md` — status update

### Key reference files (not modified)
- `packages/slack/src/message-handler.ts` — `shouldProcessMessage()`, `isBotMentioned()`, `processMessage()`
- `packages/slack/src/types.ts` — `ISlackSessionManager`, `SlackMessageEvent` interfaces
- `packages/core/src/fleet-manager/discord-manager.ts` — has same session pattern but per-channel (less impacted)
