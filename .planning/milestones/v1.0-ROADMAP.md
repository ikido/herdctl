# Milestone v1.0: Security Audit System

**Status:** SHIPPED 2026-02-05
**Phases:** 1-8
**Total Plans:** 9

## Overview

A comprehensive security intelligence system for herdctl that operates like a "full-time security researcher." Starting with persistent state infrastructure, we built four parallel codebase mapper agents, three investigation agents, and orchestrator commands that coordinate them. Each phase delivered a complete, verifiable capability â€” from state tracking through daily automated audits with dedicated branch commits.

## Phases

### Phase 1: State Infrastructure

**Goal**: Security audits have persistent memory that tracks position, coverage, investigations, and session continuity
**Depends on**: Nothing (first phase)
**Requirements**: STATE-01, STATE-02, STATE-03, STATE-04, STATE-05
**Plans**: 1 plan

Plans:
- [x] 01-01-PLAN.md - Create STATE.md with persistent audit memory (Current Position, Coverage Status, Active Investigations, Accumulated Context, Update Protocol)

**Details:**
- Created .security/STATE.md with YAML frontmatter for machine parsing
- Five-layer structure: Position, Coverage, Investigations, Context, Protocol
- Staleness thresholds: 7 days or 15 commits

### Phase 2: Mapper Agent Definitions

**Goal**: Four specialized agents exist that can analyze the codebase for attack surface, data flows, security controls, and threat vectors
**Depends on**: Phase 1
**Requirements**: MAP-01, MAP-02, MAP-03, MAP-04
**Plans**: 2 plans

Plans:
- [x] 02-01-PLAN.md - Create attack-surface-mapper and data-flow-tracer agent definitions (input-focused mappers)
- [x] 02-02-PLAN.md - Create security-controls-mapper and threat-vector-analyzer agent definitions (defense/risk-focused mappers)

**Details:**
- attack-surface-mapper (408 lines): Entry points, APIs, trust boundaries
- data-flow-tracer (529 lines): User input to sensitive operations
- security-controls-mapper (343 lines): Validation, auth, defenses
- threat-vector-analyzer (440 lines): T1-T5 herdctl-specific threats

### Phase 3: Mapping Orchestrator

**Goal**: User can run /security-map-codebase to spawn parallel mappers and generate comprehensive security documentation
**Depends on**: Phase 2
**Requirements**: CMD-01, MAP-05, MAP-06
**Plans**: 1 plan

Plans:
- [x] 03-01-PLAN.md - Create /security-map-codebase orchestrator and run initial mapping

**Details:**
- Spawns 4 mapper agents in parallel using run_in_background
- Produces 1,047 lines of security documentation
- Auto-triggers on 15+ commits OR 7+ days since mapping
- Updates STATE.md with mapping metadata

### Phase 4: Hot-Spot Verifier

**Goal**: Critical security files from HOT-SPOTS.md can be automatically verified for regressions
**Depends on**: Phase 3
**Requirements**: INV-01, CMD-03
**Plans**: 1 plan

Plans:
- [x] 04-01-PLAN.md - Create hot-spot-verifier agent definition (verification-focused investigator)

**Details:**
- hot-spot-verifier (565 lines): Verifies 13 critical hot spots
- Returns to orchestrator (not write docs) pattern
- Brief on passes, detailed on failures
- Distinguishes accepted risks (WARN) from new findings (FAIL)

### Phase 5: Question Investigator

**Goal**: Open security questions from CODEBASE-UNDERSTANDING.md can be systematically researched
**Depends on**: Phase 4
**Requirements**: INV-02, CMD-04
**Plans**: 1 plan

Plans:
- [x] 05-01-PLAN.md - Create question-investigator agent definition (research-focused investigator)

**Details:**
- question-investigator (702 lines): 4 investigation types
- Evidence required for all findings including 'not found'
- Distinguishes verified safe from not found
- Recommends question status updates

### Phase 6: Change Analyzer

**Goal**: Recent code changes can be automatically analyzed for security implications
**Depends on**: Phase 5
**Requirements**: INV-03, CMD-05
**Plans**: 1 plan

Plans:
- [x] 06-01-PLAN.md - Create change-analyzer agent definition (git-change-focused investigator)

**Details:**
- change-analyzer (1146 lines): 5 change categories
- Hot Spot, Entry Point, Pattern, Adjacent, Non-Security
- Filters non-production first
- First-match-wins category ordering

### Phase 7: Audit Orchestrator

**Goal**: User can run /security-audit to perform comprehensive incremental audits with automatic subagent delegation
**Depends on**: Phase 6
**Requirements**: CMD-02, INT-01, INT-02, INT-04
**Plans**: 1 plan

Plans:
- [x] 07-01-PLAN.md - Create /security-audit orchestrator with 5-phase flow and conditional agent spawning

**Details:**
- 5-phase flow: scanner -> change-analyzer -> parallel investigation -> aggregation -> documentation
- Conditional spawning based on detected changes
- <20% context usage, delegates depth to subagents
- PASS/WARN/FAIL determination from combined results

### Phase 8: Daily Automation

**Goal**: Security audits can run fully automated on a schedule with results committed to dedicated branch
**Depends on**: Phase 7
**Requirements**: CMD-06, CMD-07, INT-03
**Plans**: 1 plan

Plans:
- [x] 08-01-PLAN.md - Update /security-audit-daily meta-orchestrator with branch workflow and inline audit

**Details:**
- 9-phase meta-orchestrator with branch isolation
- Inline audit (not subagent) for branch context preservation
- GREEN/YELLOW/RED executive summary
- --force-with-lease for safe push after rebase

---

## Milestone Summary

**Key Decisions:**

- YAML frontmatter for machine-parseable audit state
- Reference-not-duplicate pattern for cross-document linking
- 7 days / 15 commits staleness thresholds
- T1-T5 threat taxonomy for herdctl-specific threats
- Conditional agent spawning based on detected changes
- Inline execution for daily automation (branch context)
- GREEN/YELLOW/RED status determination

**Issues Resolved:**

- Context management for multi-agent orchestration (solved with <20% budget + delegation)
- Branch context loss during subagent spawns (solved with inline execution)
- Mapping staleness detection (solved with dual threshold: time OR commits)

**Issues Deferred:**

- /security-deep-dive command (v2)
- finding-investigator agent (v2)
- Configurable staleness thresholds (v2)

**Technical Debt Incurred:**

- 4 human verification tests recommended for Phase 8 E2E workflow

---

_For current project status, see .planning/PROJECT.md_
