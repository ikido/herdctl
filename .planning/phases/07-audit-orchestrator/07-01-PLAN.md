---
phase: 07-audit-orchestrator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/security-audit.md
autonomous: true

must_haves:
  truths:
    - "/security-audit runs scan.ts as first phase and integrates results"
    - "/security-audit conditionally spawns change-analyzer when commits exist since last audit"
    - "/security-audit conditionally spawns hot-spot-verifier when change-analyzer recommends VERIFY"
    - "/security-audit conditionally spawns question-investigator when High priority questions exist"
    - "/security-audit writes intelligence report to .security/intel/YYYY-MM-DD.md"
    - "/security-audit updates FINDINGS-INDEX.md with new/resolved findings"
    - "/security-audit updates STATE.md frontmatter after completion"
  artifacts:
    - path: ".claude/commands/security-audit.md"
      provides: "Audit orchestrator command with 5-phase flow"
      min_lines: 300
  key_links:
    - from: ".claude/commands/security-audit.md"
      to: ".security/tools/scan.ts"
      via: "pnpm security --json --save invocation"
      pattern: "pnpm security.*--json"
    - from: ".claude/commands/security-audit.md"
      to: ".claude/agents/security/change-analyzer.md"
      via: "Task tool spawning with conditional logic"
      pattern: "change-analyzer"
    - from: ".claude/commands/security-audit.md"
      to: ".claude/agents/security/hot-spot-verifier.md"
      via: "Task tool spawning when VERIFY recommended"
      pattern: "hot-spot-verifier"
    - from: ".claude/commands/security-audit.md"
      to: ".claude/agents/security/question-investigator.md"
      via: "Task tool spawning when High priority questions exist"
      pattern: "question-investigator"
---

<objective>
Replace the existing monolithic /security-audit command with a new orchestrator that coordinates investigation agents.

Purpose: Transform security audits from a single-agent monolithic approach to a coordinated multi-agent system that stays under 20% context by delegating deep analysis to specialized subagents.

Output: A complete /security-audit orchestrator command in `.claude/commands/security-audit.md` that:
1. Runs scan.ts as Phase 1 for deterministic findings
2. Spawns change-analyzer in Phase 2 when commits exist
3. Conditionally spawns hot-spot-verifier and question-investigator in Phase 3 based on change-analyzer results
4. Aggregates all results in Phase 4
5. Updates documentation and commits in Phase 5
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing command to REPLACE (study structure, then rewrite completely)
@.claude/commands/security-audit.md

# Pattern to follow (spawning parallel agents)
@.claude/commands/security-map-codebase.md

# Agent definitions (understand what they return)
@.claude/agents/security/change-analyzer.md
@.claude/agents/security/hot-spot-verifier.md
@.claude/agents/security/question-investigator.md

# Research for this phase
@.planning/phases/07-audit-orchestrator/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /security-audit orchestrator command</name>
  <files>.claude/commands/security-audit.md</files>
  <action>
REPLACE the existing security-audit.md with a new orchestrator command.

**Structure to follow (based on security-map-codebase.md pattern):**

1. **Frontmatter:**
```yaml
---
name: security-audit
description: Run comprehensive incremental security audit with conditional subagent delegation
allowed-tools:
  - Read
  - Bash
  - Glob
  - Grep
  - Write
  - Edit
  - Task
---
```

2. **Objective section:**
- Clear statement of what the command does
- What output artifacts are created
- When to use this command

3. **Context section:**
- When to run (manual trigger or part of daily workflow)
- State tracking via STATE.md
- What documents get updated

4. **Process section with 5 phases:**

**Phase 1: Scanner Phase (~2 seconds)**
```bash
pnpm security --json --save
```
- Parse JSON output for new findings
- Store baseline comparison with previous scan
- Record scanner results for aggregation

**Phase 2: Change Detection Phase**
- Read STATE.md frontmatter for last_audit date
- Count commits since last audit:
```bash
git log --since="$LAST_AUDIT" --oneline --no-merges | wc -l
```
- If commits > 0: Spawn change-analyzer agent (run_in_background: false - need results for routing)
- If no commits: Skip to Phase 4

**Conditional spawning logic for change-analyzer:**
```
Use Task tool with:
- subagent_type: "change-analyzer"
- model: "{resolved_model}" (from profile)
- run_in_background: false
- description: "Analyze changes since last audit"

Prompt must include:
- Last audit date from STATE.md
- Instructions to return results, not write documents
```

**Phase 3: Investigation Phase (conditional, parallel)**
Based on change-analyzer results:

IF change-analyzer recommends "VERIFY" (Category 1 hot spot touches):
- Spawn hot-spot-verifier with file list from change-analyzer results
- Use run_in_background: true

IF open High priority questions exist in CODEBASE-UNDERSTANDING.md:
- Read Open Security Questions table
- Find highest priority Open question
- Spawn question-investigator with that question
- Use run_in_background: true

Wait for all spawned agents to complete before proceeding.

**Phase 4: Aggregation Phase**
Collect all agent results into structured intelligence report:
- Scanner findings (count + severity breakdown)
- Change analysis summary (categories + key files only)
- Verification results (pass/fail status table)
- Investigation findings (answer + evidence)

Overall audit result: PASS | WARN | FAIL
- PASS: All verifications pass, no new High/Critical findings
- WARN: Warnings present but no failures
- FAIL: New High/Critical findings or verification failures

**Phase 5: Documentation Phase**
1. Write intelligence report to `.security/intel/YYYY-MM-DD.md`
   - Use template from research (see 07-RESEARCH.md Code Examples section)
   - Include all aggregated results
   - Keep under 500 lines

2. Update FINDINGS-INDEX.md:
   - Add new findings from scanner (with fresh IDs)
   - Update status of existing findings if changed
   - Move resolved findings to Resolved section

3. Update CODEBASE-UNDERSTANDING.md (if question-investigator ran):
   - Update question status based on investigator's recommendation
   - Add findings to Notes column

4. Update STATE.md frontmatter:
```bash
TODAY=$(date +%Y-%m-%d)
NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)
sed -i '' "s/^last_updated:.*/last_updated: $NOW/" .security/STATE.md
sed -i '' "s/^last_audit:.*/last_audit: $TODAY/" .security/STATE.md
sed -i '' "s/^commits_since_audit:.*/commits_since_audit: 0/" .security/STATE.md
```

5. Commit all changes (if commit_docs=true in .planning/config.json):
```bash
git add .security/intel/YYYY-MM-DD.md
git add .security/intel/FINDINGS-INDEX.md
git add .security/CODEBASE-UNDERSTANDING.md
git add .security/STATE.md
git commit -m "security: daily audit YYYY-MM-DD

- Scanner: [status] ([N] findings)
- Changes: [N] commits analyzed
- Verification: [PASS/WARN/FAIL]
- Questions: [N] investigated

Generated by /security-audit"
```

**Context management rules:**
- Orchestrator only reads STATE.md, HOT-SPOTS.md, CODEBASE-UNDERSTANDING.md for routing decisions
- Never read source files directly (delegate to subagents)
- Agent results are already structured and bounded
- Target: <20% context usage

**Success criteria section:**
Checklist for complete audit
  </action>
  <verify>
Verify the new command file exists and has the required structure:
```bash
# File exists with minimum content
wc -l .claude/commands/security-audit.md

# Has frontmatter
head -20 .claude/commands/security-audit.md | grep -E "^name:|^description:|^allowed-tools:"

# Has 5 phases
grep -c "Phase [12345]:" .claude/commands/security-audit.md

# References all 3 agents
grep -c "change-analyzer\|hot-spot-verifier\|question-investigator" .claude/commands/security-audit.md

# References scan.ts
grep "pnpm security.*--json" .claude/commands/security-audit.md

# Has conditional spawning logic
grep -c "IF\|If\|if.*VERIFY\|if.*High priority" .claude/commands/security-audit.md
```
  </verify>
  <done>
- security-audit.md is >300 lines with complete 5-phase orchestration
- All 3 investigation agents are conditionally spawned
- scan.ts is run as first phase
- Intelligence report template is included
- STATE.md, FINDINGS-INDEX.md, CODEBASE-UNDERSTANDING.md update steps included
- Context management rules documented
  </done>
</task>

</tasks>

<verification>
After task completion, verify the orchestrator:

1. **Structure check:**
```bash
# Has proper frontmatter
head -15 .claude/commands/security-audit.md

# Has all 5 phases documented
grep -E "Phase [12345]" .claude/commands/security-audit.md
```

2. **Agent spawning check:**
```bash
# References all 3 investigator agents
grep -E "change-analyzer|hot-spot-verifier|question-investigator" .claude/commands/security-audit.md
```

3. **Conditional logic check:**
```bash
# Has conditional spawning (not always-spawn-all)
grep -A5 "if.*commits" .claude/commands/security-audit.md
grep -A5 "if.*VERIFY" .claude/commands/security-audit.md
grep -A5 "if.*High.*priority" .claude/commands/security-audit.md
```

4. **Integration check:**
```bash
# Integrates scan.ts
grep "pnpm security" .claude/commands/security-audit.md

# Updates STATE.md
grep "STATE.md" .claude/commands/security-audit.md

# Updates FINDINGS-INDEX.md
grep "FINDINGS-INDEX" .claude/commands/security-audit.md
```
</verification>

<success_criteria>
- [ ] security-audit.md exists with >300 lines of orchestrator content
- [ ] Frontmatter specifies allowed tools including Task tool
- [ ] Phase 1 runs scan.ts with --json --save
- [ ] Phase 2 conditionally spawns change-analyzer when commits > 0
- [ ] Phase 3 conditionally spawns hot-spot-verifier when VERIFY recommended
- [ ] Phase 3 conditionally spawns question-investigator when High priority questions exist
- [ ] Phase 4 aggregates results from all agents
- [ ] Phase 5 writes intelligence report, updates living documents, commits
- [ ] Context management rules documented (<20% target)
- [ ] Overall audit result determination (PASS/WARN/FAIL) documented
</success_criteria>

<output>
After completion, create `.planning/phases/07-audit-orchestrator/07-01-SUMMARY.md`
</output>
