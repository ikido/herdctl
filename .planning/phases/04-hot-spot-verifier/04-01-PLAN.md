---
phase: 04-hot-spot-verifier
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/agents/security/hot-spot-verifier.md
autonomous: true

must_haves:
  truths:
    - "hot-spot-verifier agent can be spawned and verifies security properties of critical files"
    - "Agent reads HOT-SPOTS.md and checks specific security properties from 'What to Check' column"
    - "Agent returns verification report with pass/fail status (not documentation like mappers)"
  artifacts:
    - path: ".claude/agents/security/hot-spot-verifier.md"
      provides: "Hot spot verification agent definition"
      contains: "name: hot-spot-verifier"
      min_lines: 200
  key_links:
    - from: ".claude/agents/security/hot-spot-verifier.md"
      to: ".security/HOT-SPOTS.md"
      via: "Read tool input"
      pattern: "HOT-SPOTS\\.md"
    - from: ".claude/agents/security/hot-spot-verifier.md"
      to: "Orchestrator response"
      via: "Verification report return"
      pattern: "## Verification Report"
---

<objective>
Create the hot-spot-verifier agent definition that verifies security properties of critical files from HOT-SPOTS.md.

Purpose: Unlike mapper agents (which produce comprehensive documentation), this is an investigator agent that produces verification reports with pass/fail status. It enables /security-audit to automatically verify that security controls in critical files have not regressed.

Output: Single agent definition file in `.claude/agents/security/` that reads HOT-SPOTS.md and returns structured verification results.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-hot-spot-verifier/04-RESEARCH.md
@.claude/agents/security/attack-surface-mapper.md
@.security/HOT-SPOTS.md
@.security/GSD-SECURITY-SYSTEM-SPEC.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hot-spot-verifier agent definition</name>
  <files>.claude/agents/security/hot-spot-verifier.md</files>
  <action>
Create the hot-spot-verifier agent definition file following the GSD agent structure pattern from attack-surface-mapper.md, but adapted for VERIFICATION (not mapping).

**Key difference from mapper agents:** This agent RETURNS results to the orchestrator (for aggregation), rather than writing a document directly.

**Frontmatter:**
```yaml
---
name: hot-spot-verifier
description: Verifies security properties of critical files from HOT-SPOTS.md have not regressed. Use during security audits.
tools: Read, Bash, Grep, Glob
model: sonnet
color: yellow
---
```

Note: No `Write` tool - this agent returns results, doesn't write documents.

**Sections to include:**

1. `<role>` - Explain the agent verifies security properties of critical files, reads HOT-SPOTS.md to understand what to check, and returns a verification report with pass/fail status per hot spot.

2. `<why_this_matters>` - Explain:
   - `/security-audit` spawns this when critical files modified since last audit
   - Results get aggregated into intelligence report
   - Catches regressions in security controls
   - Different from mappers: verification (pass/fail), not documentation

3. `<philosophy>` - Verification-focused principles:
   - **Verify specific properties** - Check what HOT-SPOTS.md says to check, not re-map the entire surface
   - **Brief on passes, detailed on failures** - Green checkmarks need no explanation, red ones need evidence
   - **Distinguish new findings from accepted risks** - Cross-reference STATE.md for accepted risks
   - **Include file paths** - Every check needs exact location
   - **Be thorough but targeted** - Only verify files you're asked to verify

4. `<process>` with steps:

   - `parse_input`: Understand what to verify
     - If given a list of modified files: only verify those hot spots
     - If no list: verify all Critical hot spots + check High-Risk for changes
     - Read HOT-SPOTS.md to get the "What to Check" for each file

   - `verify_critical_hot_spots`: For each critical hot spot:
     - Parse the "What to Check" column from HOT-SPOTS.md
     - Run specific grep/read commands to verify each property
     - Record pass/fail with evidence
     - Note if any checks are accepted risks (from STATE.md)

   - `verify_high_risk_if_modified`: For each high-risk hot spot:
     - Check if file was modified (use provided list or git diff)
     - If modified, verify using "What to Check" criteria
     - Skip if not modified

   - `run_pattern_searches`: Execute the grep patterns from HOT-SPOTS.md
     - Compare to known baseline (last audit)
     - Flag any new matches

   - `return_verification_report`: Return structured report (NOT write to file):
     ```markdown
     ## Verification Report

     **Date:** YYYY-MM-DD
     **Hot spots checked:** N of M
     **Result:** PASS | FAIL | WARN

     ### Critical Hot Spots

     #### container-manager.ts: PASS
     - [x] Capability drops intact (CapDrop: ["ALL"])
     - [x] no-new-privileges present

     #### container-runner.ts: WARN
     - [x] Shell escaping function exists
     - [ ] **FINDING:** Shell escaping incomplete (#009 - known tech debt)

     [... more hot spots ...]

     ### High-Risk Hot Spots (Modified Only)

     [... only those that were modified ...]

     ### Pattern Search Results

     [... any new grep matches ...]

     ### Summary
     - Critical: N/M passed
     - High-risk: N/M verified (K skipped - not modified)
     - New findings: J
     - Accepted risks noted: L
     ```

5. `<verification_commands>` - Specific commands for each hot spot from HOT-SPOTS.md:
   ```bash
   # container-manager.ts - Docker security defaults
   grep -n "CapDrop.*ALL" packages/core/src/runner/runtime/container-manager.ts
   grep -n "no-new-privileges" packages/core/src/runner/runtime/container-manager.ts
   grep -n "hostConfigOverride" packages/core/src/runner/runtime/container-manager.ts

   # container-runner.ts - Shell escaping
   grep -n "escapeShellArg\|shellEscape" packages/core/src/runner/runtime/container-runner.ts

   # schema.ts - Validation patterns
   grep -n "AGENT_NAME_PATTERN" packages/core/src/config/schema.ts
   grep -n "\.strict()" packages/core/src/config/schema.ts

   # path-safety.ts - Traversal defense
   grep -n "SAFE_IDENTIFIER_PATTERN" packages/core/src/state/utils/path-safety.ts
   grep -n "buildSafeFilePath" packages/core/src/state/utils/path-safety.ts

   # interpolate.ts - No code execution
   grep -n "eval\|Function(" packages/core/src/config/interpolate.ts

   # shell.ts - Timeout and limits
   grep -n "timeout\|maxBuffer" packages/core/src/hooks/runners/shell.ts
   ```

6. `<parsing_hot_spots>` - How to extract verification criteria from HOT-SPOTS.md:
   ```bash
   # Extract critical hot spot file paths
   grep -A100 "## Critical Hot Spots" .security/HOT-SPOTS.md | \
     grep "^\|" | grep "packages/" | \
     sed 's/.*`\([^`]*\)`.*/\1/'

   # Extract high-risk hot spot file paths
   grep -A100 "## High-Risk Hot Spots" .security/HOT-SPOTS.md | \
     grep "^\|" | grep "packages/" | \
     sed 's/.*`\([^`]*\)`.*/\1/'
   ```

7. `<forbidden_files>` - Same as mapper agents (never read .env, secrets, credentials)

8. `<critical_rules>`:
   - RETURN RESULTS (do NOT write documents - orchestrator aggregates)
   - VERIFY SPECIFIC PROPERTIES (use "What to Check" from HOT-SPOTS.md)
   - BRIEF ON PASSES (checkmark only), DETAILED ON FAILURES (include evidence)
   - DISTINGUISH ACCEPTED RISKS (cross-reference STATE.md decisions)
   - INCLUDE FILE PATHS AND LINE NUMBERS (for failures especially)
   - USE PASS/FAIL/WARN STATUS (WARN for accepted risks or known tech debt)

9. `<success_criteria>`:
   - [ ] All critical hot spots verified with pass/fail status
   - [ ] Modified high-risk hot spots verified
   - [ ] Each verification has evidence (line numbers, grep output)
   - [ ] Accepted risks distinguished from new findings
   - [ ] Verification report returned with clear summary
  </action>
  <verify>
File exists at `.claude/agents/security/hot-spot-verifier.md` with:
- YAML frontmatter with name: hot-spot-verifier, model: sonnet, NO Write tool
- `<role>` section explaining verification (not mapping) purpose
- `<process>` with parse_input, verify_critical_hot_spots, verify_high_risk_if_modified, return_verification_report steps
- `<verification_commands>` with specific grep commands for each hot spot from HOT-SPOTS.md
- `<critical_rules>` emphasizing RETURN results (not write documents)
- At least 200 lines of substantive content

```bash
wc -l .claude/agents/security/hot-spot-verifier.md
grep -c "## Verification Report" .claude/agents/security/hot-spot-verifier.md
grep "tools:" .claude/agents/security/hot-spot-verifier.md | grep -v Write
```
  </verify>
  <done>
hot-spot-verifier agent definition exists with verification-focused structure, specific verification commands for all HOT-SPOTS.md entries, and returns verification report (not writes document)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify agent integrates with HOT-SPOTS.md structure</name>
  <files>.claude/agents/security/hot-spot-verifier.md</files>
  <action>
Read HOT-SPOTS.md and verify the agent definition covers ALL hot spots listed.

**Checklist to verify:**

1. **Critical Hot Spots (6 files) - all must have verification commands:**
   - container-manager.ts: Docker security hardening
   - container-runner.ts: Docker exec, shell escaping
   - schema.ts: Input validation
   - path-safety.ts: Path traversal defense
   - interpolate.ts: Environment substitution
   - shell.ts: Shell command execution

2. **High-Risk Hot Spots (7 files) - must be mentioned in high-risk verification step:**
   - cli-runtime.ts
   - docker-config.ts
   - session.ts
   - job-metadata.ts
   - loader.ts
   - hook-runner.ts
   - job-control.ts

3. **Pattern searches - grep patterns from HOT-SPOTS.md must be included:**
   - Path construction without safety
   - New shell execution
   - New eval or dynamic code
   - Secrets in logs
   - New Docker capabilities

4. **Audit checklist alignment - verification report should enable checking off items**

If any are missing from the agent definition, add them.
  </action>
  <verify>
```bash
# All 6 critical hot spot files mentioned
grep -c "container-manager.ts\|container-runner.ts\|schema.ts\|path-safety.ts\|interpolate.ts\|shell.ts" .claude/agents/security/hot-spot-verifier.md

# High-risk section exists
grep -c "High-Risk\|high-risk" .claude/agents/security/hot-spot-verifier.md

# Pattern search commands included
grep -c "path.join\|path.resolve" .claude/agents/security/hot-spot-verifier.md
```
  </verify>
  <done>
Agent definition covers all critical and high-risk hot spots from HOT-SPOTS.md with appropriate verification commands
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `.claude/agents/security/hot-spot-verifier.md` exists with >200 lines
2. Agent has correct frontmatter (model: sonnet, NO Write tool)
3. Agent RETURNS verification report (search for "## Verification Report" template)
4. Agent covers all 6 critical hot spots with specific verification commands
5. Agent has process for high-risk hot spots (verify only if modified)
6. Agent includes pattern search section matching HOT-SPOTS.md grep patterns

```bash
ls -la .claude/agents/security/hot-spot-verifier.md
wc -l .claude/agents/security/hot-spot-verifier.md
grep "tools:" .claude/agents/security/hot-spot-verifier.md
grep -c "PASS\|FAIL\|WARN" .claude/agents/security/hot-spot-verifier.md
```
</verification>

<success_criteria>
- [ ] hot-spot-verifier.md created with complete agent structure
- [ ] Agent has correct frontmatter (name, description, tools: Read/Bash/Grep/Glob, model: sonnet, color: yellow)
- [ ] Agent RETURNS verification report to orchestrator (not writes document)
- [ ] All 6 critical hot spots have specific verification commands
- [ ] High-risk hot spots section with conditional verification
- [ ] Pattern search section matching HOT-SPOTS.md grep patterns
- [ ] Verification report template with pass/fail/warn status format
</success_criteria>

<output>
After completion, create `.planning/phases/04-hot-spot-verifier/04-01-SUMMARY.md`
</output>
