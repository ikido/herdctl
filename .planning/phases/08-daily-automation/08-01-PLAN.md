---
phase: 08-daily-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .claude/commands/security-audit-daily.md
autonomous: true

must_haves:
  truths:
    - "/security-audit-daily switches to security-audits branch before running audit"
    - "/security-audit-daily returns user to original branch after completion"
    - "/security-audit-daily generates executive summary with GREEN/YELLOW/RED status"
    - "/security-audit-daily commits all artifacts with status-rich commit message"
    - "System can run unattended without user intervention"
  artifacts:
    - path: ".claude/commands/security-audit-daily.md"
      provides: "Meta-orchestrator with branch workflow and inline audit"
      min_lines: 300
      contains: "git checkout -B security-audits"
  key_links:
    - from: ".claude/commands/security-audit-daily.md"
      to: "/security-audit workflow"
      via: "inline process steps (not subagent spawn)"
      pattern: "Phase.*Scanner|change-analyzer|hot-spot-verifier"
    - from: ".claude/commands/security-audit-daily.md"
      to: "git branch management"
      via: "branch save/switch/restore pattern"
      pattern: "ORIGINAL_BRANCH.*git branch"
---

<objective>
Update /security-audit-daily to be a full meta-orchestrator that sequences audit + review with branch isolation and unattended execution.

Purpose: Enable fully automated daily security audits that commit results to a dedicated branch, keeping main branch clean from automated commits.

Output:
- Updated `.claude/commands/security-audit-daily.md` with branch management and inline audit workflow
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-daily-automation/08-RESEARCH.md
@.planning/phases/07-audit-orchestrator/07-01-SUMMARY.md
@.claude/commands/security-audit.md
@.claude/commands/security-audit-daily.md
@.claude/commands/security-audit-review.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update /security-audit-daily with branch workflow and inline audit</name>
  <files>.claude/commands/security-audit-daily.md</files>
  <action>
Rewrite security-audit-daily.md as a proper meta-orchestrator command. The new structure must include:

**Frontmatter:**
```yaml
---
name: security-audit-daily
description: Automated daily security audit with branch isolation and executive summary
allowed-tools:
  - Read
  - Bash
  - Glob
  - Grep
  - Write
  - Edit
  - Task
---
```

**Objective section:** Explain this is a meta-orchestrator that wraps /security-audit with branch management for unattended daily execution.

**Process steps (use step tags like security-audit.md):**

1. **Phase 0: Pre-flight checks**
   - Check for uncommitted changes (`git diff-index --quiet HEAD --`)
   - If dirty, exit with clear error message
   - Save original branch: `ORIGINAL_BRANCH=$(git branch --show-current)`

2. **Phase 1: Branch setup**
   - Switch to security-audits branch: `git checkout -B security-audits`
   - Rebase on main: `git rebase main --quiet` (handle conflicts gracefully)
   - Note: Use checkout -B to create OR switch

3. **Phase 2: Run security audit (INLINE)**
   - Copy the entire 5-phase process from /security-audit.md inline
   - This is NOT a subagent spawn - the audit runs in the same context
   - Reason: Subagents don't inherit branch state; files must be on security-audits branch
   - Include: Scanner phase, change detection, investigation (conditional), aggregation, documentation
   - Capture key results for executive summary: AUDIT_RESULT, NEW_FINDINGS, QUESTIONS_INVESTIGATED

4. **Phase 3: Run self-review (INLINE, optional)**
   - Include /security-audit-review process inline
   - Write review to `.security/reviews/YYYY-MM-DD.md`
   - Extract AUDIT_GRADE for summary

5. **Phase 4: Generate executive summary**
   - Write to `.security/summaries/YYYY-MM-DD.md`
   - Determine status: GREEN/YELLOW/RED based on:
     - GREEN: AUDIT_RESULT=PASS, no new Critical/High, AUDIT_GRADE B or better
     - YELLOW: AUDIT_RESULT=WARN, new Medium, AUDIT_GRADE C
     - RED: AUDIT_RESULT=FAIL, new Critical/High, AUDIT_GRADE D
   - Include Quick Stats table with metrics from all phases
   - Include Action Items section (Immediate/This Week)

6. **Phase 5: Commit and push**
   - Stage security artifacts only: `git add .security/`
   - Use status-rich commit message:
     ```
     security: daily audit YYYY-MM-DD

     Status: GREEN/YELLOW/RED
     Overall Result: PASS/WARN/FAIL
     New findings: N
     Questions investigated: N
     Audit grade: A/B/C/D

     Summary: [one-liner from executive summary]
     ```
   - Push with: `git push -u origin security-audits --force-with-lease`
   - Use --force-with-lease (not --force) for safety after rebase

7. **Phase 6: Restore original branch**
   - `git checkout "$ORIGINAL_BRANCH" --quiet`
   - Print confirmation: "Returned to branch: $ORIGINAL_BRANCH"
   - This happens even if earlier phases fail (use trap or explicit finally pattern)

**Edge cases section:**
- Uncommitted changes: Exit early with helpful message
- Rebase conflicts: Log warning, continue on current state
- Push fails: Note in output, don't fail entire workflow
- First run (no security-audits branch): checkout -B creates it

**Success criteria section:**
- Checklist matching must_haves truths
- Branch management worked correctly
- All files on security-audits branch
- Executive summary created
- Commit message includes status

**Key insight from research:** The audit workflow runs INLINE (not as subagent) because:
1. Subagents have isolated context and can't inherit branch state
2. File writes need to happen on security-audits branch
3. Meta-orchestrator coordinates, so it can include the workflow directly

Keep the command under 500 lines. Focus on the orchestration structure; the inline audit process can reference /security-audit.md for details but must include the key steps.
  </action>
  <verify>
```bash
# Verify command file structure
grep -c "git checkout -B security-audits" .claude/commands/security-audit-daily.md
grep -c "ORIGINAL_BRANCH" .claude/commands/security-audit-daily.md
grep -c "force-with-lease" .claude/commands/security-audit-daily.md
grep -c "GREEN.*YELLOW.*RED\|status:" .claude/commands/security-audit-daily.md
wc -l .claude/commands/security-audit-daily.md
```
All patterns should be present. File should be 300-500 lines.
  </verify>
  <done>
Meta-orchestrator command exists with:
- Pre-flight uncommitted changes check
- Branch save/switch/restore workflow
- Inline audit process (not subagent)
- Executive summary generation
- Status-rich commit message
- Push with --force-with-lease
- Return to original branch
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify agent locations satisfy INT-03</name>
  <files>N/A (verification only)</files>
  <action>
Verify all 7 security agents are in `.claude/agents/security/` directory.

Expected agents (from Phase 2-6):
1. attack-surface-mapper.md
2. data-flow-tracer.md
3. security-controls-mapper.md
4. threat-vector-analyzer.md
5. change-analyzer.md
6. hot-spot-verifier.md
7. question-investigator.md

Run: `ls -la .claude/agents/security/`

If all 7 are present, INT-03 is satisfied. Document the verification in the summary.
If any are missing, identify which and note as issue (should not happen based on prior phases).
  </action>
  <verify>
```bash
ls .claude/agents/security/*.md | wc -l
# Should return 7

ls .claude/agents/security/
# Should list all 7 agent files
```
  </verify>
  <done>
All 7 security agents confirmed in `.claude/agents/security/` directory, satisfying INT-03.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Command structure:** Read security-audit-daily.md and verify it has:
   - Frontmatter with allowed-tools including Task
   - Branch management workflow (save, switch, restore)
   - Inline audit process (not just a reference)
   - Executive summary generation
   - Commit message template with status

2. **INT-03 compliance:** ls .claude/agents/security/ shows 7 agent files

3. **Unattended execution test (conceptual):**
   - Command handles dirty working tree gracefully (exits with message)
   - Command creates branch if doesn't exist
   - Command returns to original branch after completion
</verification>

<success_criteria>
Phase 8 is complete when:

1. `/security-audit-daily` meta-orchestrator exists with full branch workflow
2. Command can run unattended (no user prompts required)
3. All 7 agent definitions are in `.claude/agents/security/`
4. Executive summary uses GREEN/YELLOW/RED status from audit results
5. Commit message includes status, findings count, and audit grade

Requirements satisfied:
- CMD-06: /security-audit-daily meta-orchestrator
- CMD-07: Commits to security-audits branch
- INT-03: Agents in .claude/agents/security/
</success_criteria>

<output>
After completion, create `.planning/phases/08-daily-automation/08-01-SUMMARY.md`
</output>
