---
phase: 01-runtime-abstraction-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - packages/core/src/runner/job-executor.ts
  - packages/core/src/runner/types.ts
  - packages/core/src/runner/index.ts
  - packages/core/src/fleet-manager/job-control.ts
  - packages/core/src/fleet-manager/schedule-executor.ts
autonomous: true

must_haves:
  truths:
    - "JobExecutor accepts RuntimeInterface instead of SDKQueryFunction"
    - "JobExecutor.execute() uses runtime.execute() instead of this.sdkQuery()"
    - "job-control.ts uses RuntimeFactory to create runtime, not direct SDK import"
    - "schedule-executor.ts uses RuntimeFactory to create runtime, not direct SDK import"
    - "SDK import only appears in SDKRuntime (runtime/sdk-runtime.ts)"
  artifacts:
    - path: "packages/core/src/runner/job-executor.ts"
      provides: "Refactored JobExecutor using RuntimeInterface"
      exports: ["JobExecutor", "executeJob"]
    - path: "packages/core/src/runner/types.ts"
      provides: "RunnerOptions with abortController field"
      contains: "abortController?: AbortController"
    - path: "packages/core/src/runner/index.ts"
      provides: "Updated runner module exports including runtime types"
      exports: ["RuntimeInterface", "RuntimeFactory", "SDKRuntime"]
    - path: "packages/core/src/fleet-manager/job-control.ts"
      provides: "JobControl using RuntimeFactory"
      contains: "RuntimeFactory.create"
    - path: "packages/core/src/fleet-manager/schedule-executor.ts"
      provides: "ScheduleExecutor using RuntimeFactory"
      contains: "RuntimeFactory.create"
  key_links:
    - from: "packages/core/src/runner/job-executor.ts"
      to: "packages/core/src/runner/runtime/interface.ts"
      via: "import { RuntimeInterface }"
      pattern: "import.*RuntimeInterface.*from.*runtime"
    - from: "packages/core/src/fleet-manager/job-control.ts"
      to: "packages/core/src/runner/index.ts"
      via: "import { RuntimeFactory }"
      pattern: "import.*RuntimeFactory.*from.*runner"
    - from: "packages/core/src/fleet-manager/schedule-executor.ts"
      to: "packages/core/src/runner/index.ts"
      via: "import { RuntimeFactory }"
      pattern: "import.*RuntimeFactory.*from.*runner"
---

<objective>
Refactor JobExecutor to use RuntimeInterface and update all call sites to use RuntimeFactory instead of direct SDK imports.

Purpose: Complete the runtime abstraction by removing direct SDK coupling from JobExecutor, job-control.ts, and schedule-executor.ts. After this plan, SDK is only imported in SDKRuntime.

Output: JobExecutor accepts RuntimeInterface, all call sites use RuntimeFactory, direct SDK imports removed from fleet-manager files.
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-runtime-abstraction-foundation/01-RESEARCH.md
@.planning/phases/01-runtime-abstraction-foundation/01-01-SUMMARY.md
@packages/core/src/runner/job-executor.ts
@packages/core/src/runner/types.ts
@packages/core/src/runner/index.ts
@packages/core/src/fleet-manager/job-control.ts
@packages/core/src/fleet-manager/schedule-executor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor JobExecutor to use RuntimeInterface</name>
  <files>
packages/core/src/runner/job-executor.ts
packages/core/src/runner/types.ts
  </files>
  <action>
Refactor JobExecutor to accept RuntimeInterface instead of SDKQueryFunction.

**Part A: Update RunnerOptions in types.ts**

Add `abortController` field to the `RunnerOptions` interface:
```typescript
export interface RunnerOptions {
  // ... existing fields ...
  /** AbortController for canceling the execution */
  abortController?: AbortController;
}
```

Add this after the `outputToFile` field (around line 35).

**Part B: Refactor job-executor.ts**

1. **Add import for RuntimeInterface:**
   ```typescript
   import type { RuntimeInterface, RuntimeExecuteOptions } from "./runtime/index.js";
   ```

2. **Remove toSDKOptions import (line 28):**
   DELETE: `import { toSDKOptions } from "./sdk-adapter.js";`

3. **Change constructor parameter:**
   - FROM: `constructor(sdkQuery: SDKQueryFunction, options: JobExecutorOptions = {})`
   - TO: `constructor(runtime: RuntimeInterface, options: JobExecutorOptions = {})`
   - Change private field from `sdkQuery` to `runtime`

4. **DELETE lines 196-206 (the toSDKOptions call and debug logging):**
   These lines call toSDKOptions and log SDK options. DELETE them entirely:
   ```typescript
   // DELETE THIS BLOCK:
   // Step 4: Build SDK options
   const sdkOptions = toSDKOptions(agent, {
     resume: options.resume,
     fork: options.fork ? true : undefined,
   });

   // DEBUG: Log SDK options to help diagnose system prompt issues
   const promptType = typeof sdkOptions.systemPrompt === "string" ? "custom" : "preset";
   this.logger.info?.(`SDK options for job ${job.id}: settingSources=${JSON.stringify(sdkOptions.settingSources)}, systemPrompt.type=${promptType}, cwd=${sdkOptions.cwd ?? "(not set)"}`);
   if (typeof sdkOptions.systemPrompt === "string") {
     this.logger.info?.(`SDK systemPrompt content (first 100 chars): ${sdkOptions.systemPrompt.substring(0, 100)}`);
   }
   ```
   The runtime now handles SDK options internally via SDKRuntime.

5. **Update execute() method (lines 209-231):**
   Replace the SDK query call with:
   ```typescript
   // Step 4: Execute agent and stream output
   try {
     let messages: AsyncIterable<SDKMessage>;

     // Catch runtime initialization errors
     try {
       messages = this.runtime.execute({
         prompt,
         agent: options.agent,
         resume: options.resume,
         fork: options.fork ? true : undefined,
         abortController: options.abortController,
       });
     } catch (initError) {
       // Wrap initialization errors with context
       throw new SDKInitializationError(
         buildErrorMessage((initError as Error).message, {
           jobId: job.id,
           agentName: agent.name,
         }),
         {
           jobId: job.id,
           agentName: agent.name,
           cause: initError as Error,
         }
       );
     }
     // ... rest of message processing loop unchanged ...
   }
   ```
   Note: The step number changes from 5 to 4 since we deleted the "Build SDK options" step.

6. **Update executeJob convenience function:**
   - FROM: `export async function executeJob(sdkQuery: SDKQueryFunction, ...)`
   - TO: `export async function executeJob(runtime: RuntimeInterface, ...)`
   - Update internal call: `const executor = new JobExecutor(runtime, executorOptions);`

7. **Keep SDKQueryFunction type** for backwards compatibility with tests, but add deprecation comment:
   ```typescript
   /**
    * SDK query function type (for dependency injection)
    * @deprecated Use RuntimeInterface instead. This type is kept for test compatibility.
    */
   export type SDKQueryFunction = ...
   ```

CRITICAL: The for-await loop processing messages stays UNCHANGED. Only the source of messages changes from this.sdkQuery() to this.runtime.execute().
  </action>
  <verify>
TypeScript compiles: `cd packages/core && pnpm exec tsc --noEmit src/runner/job-executor.ts`
Types file compiles: `cd packages/core && pnpm exec tsc --noEmit src/runner/types.ts`
Tests still import correctly: `cd packages/core && pnpm exec tsc --noEmit src/runner/__tests__/job-executor.test.ts`
  </verify>
  <done>JobExecutor constructor accepts RuntimeInterface, execute() calls this.runtime.execute(), toSDKOptions call removed, RunnerOptions has abortController field</done>
</task>

<task type="auto">
  <name>Task 2: Update call sites to use RuntimeFactory</name>
  <files>
packages/core/src/fleet-manager/job-control.ts
packages/core/src/fleet-manager/schedule-executor.ts
  </files>
  <action>
Update job-control.ts and schedule-executor.ts to use RuntimeFactory instead of direct SDK imports.

**job-control.ts changes:**

1. **Remove SDK import (line 13):**
   DELETE: `import { query as claudeSdkQuery } from "@anthropic-ai/claude-agent-sdk";`

2. **Remove SDK casting (line 39):**
   DELETE: `const sdkQuery = claudeSdkQuery as unknown as SDKQueryFunction;`

3. **Update runner import:**
   ```typescript
   import { JobExecutor, RuntimeFactory } from "../runner/index.js";
   ```
   Remove `type SDKQueryFunction` from imports.

4. **Update trigger() method (around line 137):**
   - FROM: `const executor = new JobExecutor(sdkQuery, { logger });`
   - TO:
   ```typescript
   const runtime = RuntimeFactory.create(agent);
   const executor = new JobExecutor(runtime, { logger });
   ```

**schedule-executor.ts changes:**

1. **Remove SDK import (line 16):**
   DELETE: `import { query as claudeSdkQuery } from "@anthropic-ai/claude-agent-sdk";`

2. **Remove SDK casting (lines 25-27):**
   DELETE:
   ```typescript
   // Cast the SDK query function to our internal type
   // The SDK types are slightly different but runtime-compatible
   const sdkQuery = claudeSdkQuery as unknown as SDKQueryFunction;
   ```

3. **Update runner import (line 19):**
   ```typescript
   import { JobExecutor, RuntimeFactory, type SDKMessage } from "../runner/index.js";
   ```
   Remove `type SDKQueryFunction` from imports.

4. **Update executeSchedule() method (around line 97):**
   - FROM: `const executor = new JobExecutor(sdkQuery, { logger });`
   - TO:
   ```typescript
   const runtime = RuntimeFactory.create(agent);
   const executor = new JobExecutor(runtime, { logger });
   ```

After these changes, SDK import should only exist in sdk-runtime.ts.
  </action>
  <verify>
TypeScript compiles:
- `cd packages/core && pnpm exec tsc --noEmit src/fleet-manager/job-control.ts`
- `cd packages/core && pnpm exec tsc --noEmit src/fleet-manager/schedule-executor.ts`

No SDK imports in fleet-manager:
- `grep -r "@anthropic-ai/claude-agent-sdk" packages/core/src/fleet-manager/` returns empty
  </verify>
  <done>job-control.ts and schedule-executor.ts use RuntimeFactory.create(agent), no direct SDK imports</done>
</task>

<task type="auto">
  <name>Task 3: Update runner module exports and verify cleanup</name>
  <files>packages/core/src/runner/index.ts</files>
  <action>
Update the runner module's barrel export to include runtime types and verify no SDK leakage.

**Add runtime exports to index.ts:**
```typescript
// Export runtime types and factory
export type { RuntimeInterface, RuntimeExecuteOptions } from "./runtime/index.js";
export { SDKRuntime, RuntimeFactory, type RuntimeType } from "./runtime/index.js";
```

Add these after the existing exports (around line 50).

**Verify SDK isolation:**
After all changes, run:
```bash
grep -r "@anthropic-ai/claude-agent-sdk" packages/core/src/
```

Expected: SDK import ONLY appears in:
- `packages/core/src/runner/runtime/sdk-runtime.ts`

If it appears elsewhere, those imports need to be removed.

**Run full type check:**
```bash
cd packages/core && pnpm typecheck
```

**Run tests to ensure nothing broke:**
```bash
cd packages/core && pnpm test
```

Tests may need mock updates since JobExecutor now takes RuntimeInterface. The existing test pattern of passing mock async generators should still work since RuntimeInterface.execute() returns AsyncIterable<SDKMessage>.
  </action>
  <verify>
1. `cd packages/core && pnpm typecheck` passes
2. `cd packages/core && pnpm test` passes
3. `grep -r "@anthropic-ai/claude-agent-sdk" packages/core/src/ | grep -v sdk-runtime.ts` returns empty (SDK only in SDKRuntime)
  </verify>
  <done>Runner module exports RuntimeInterface and RuntimeFactory, SDK import isolated to SDKRuntime only, all tests pass</done>
</task>

</tasks>

<verification>
1. Full build succeeds: `cd packages/core && pnpm build`
2. All tests pass: `cd packages/core && pnpm test`
3. Type check passes: `cd packages/core && pnpm typecheck`
4. SDK import isolation verified: only in sdk-runtime.ts
5. RuntimeFactory can be imported from @herdctl/core
</verification>

<success_criteria>
- JobExecutor accepts RuntimeInterface, not SDKQueryFunction
- RunnerOptions includes abortController?: AbortController field
- toSDKOptions call and sdkOptions variable deleted from JobExecutor (lines 196-206)
- job-control.ts uses RuntimeFactory.create(agent), no direct SDK import
- schedule-executor.ts uses RuntimeFactory.create(agent), no direct SDK import
- SDK import only exists in packages/core/src/runner/runtime/sdk-runtime.ts
- All existing tests pass (mock pattern still works)
- Runtime types exported from @herdctl/core
</success_criteria>

<output>
After completion, create `.planning/phases/01-runtime-abstraction-foundation/01-02-SUMMARY.md`
</output>
