---
phase: 04-documentation-and-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/runtime-showcase/herdctl.yaml
  - examples/runtime-showcase/agents/sdk-agent.yaml
  - examples/runtime-showcase/agents/cli-agent.yaml
  - examples/runtime-showcase/agents/docker-agent.yaml
  - examples/runtime-showcase/agents/mixed-fleet.yaml
  - docs/src/content/docs/guides/runtime-troubleshooting.md
autonomous: true

must_haves:
  truths:
    - "Example configs provided for cost-optimized, development, production, and mixed fleet scenarios"
    - "Troubleshooting guide addresses path resolution and Docker container issues"
    - "Anti-pattern examples show common misconfigurations with explanations"
  artifacts:
    - path: "examples/runtime-showcase/herdctl.yaml"
      provides: "Fleet config demonstrating runtime options"
      min_lines: 20
    - path: "examples/runtime-showcase/agents/docker-agent.yaml"
      provides: "Production Docker agent example"
      min_lines: 30
    - path: "docs/src/content/docs/guides/runtime-troubleshooting.md"
      provides: "Troubleshooting guide for runtime and Docker issues"
      min_lines: 100
  key_links:
    - from: "docs/src/content/docs/guides/runtime-troubleshooting.md"
      to: "examples/runtime-showcase/"
      via: "example references"
      pattern: "runtime-showcase"
---

<objective>
Create example configurations and troubleshooting documentation

Purpose: Provide copy-pastable working examples for common use cases and help users debug runtime/Docker issues
Output: New examples directory with 4+ agent configs and troubleshooting guide
</objective>

<execution_context>
@/Users/ed/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ed/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-documentation-and-testing/04-CONTEXT.md

# Existing examples for style reference
@examples/hello-world/herdctl.yaml
@examples/hello-world/agents/hello-world.yaml

# Schema reference
@packages/core/src/config/schema.ts
@packages/core/src/runner/runtime/docker-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Runtime Showcase Example Configurations</name>
  <files>
    examples/runtime-showcase/herdctl.yaml
    examples/runtime-showcase/agents/sdk-agent.yaml
    examples/runtime-showcase/agents/cli-agent.yaml
    examples/runtime-showcase/agents/docker-agent.yaml
    examples/runtime-showcase/agents/mixed-fleet.yaml
  </files>
  <action>
Create a new examples directory demonstrating all runtime configurations.

1. **Create examples/runtime-showcase/herdctl.yaml** (fleet config):
```yaml
# Runtime Showcase Fleet
# Demonstrates SDK, CLI, and Docker runtime configurations

workspace: runtime-showcase

agents:
  - path: agents/sdk-agent.yaml
    # Development: SDK runtime, no Docker (simplest setup)
  - path: agents/cli-agent.yaml
    # Cost-optimized: CLI runtime for Max plan users
  - path: agents/docker-agent.yaml
    # Production: Docker isolation with security hardening
  - path: agents/mixed-fleet.yaml
    # Mixed: Shows overrides for different runtimes per schedule

defaults:
  model: claude-sonnet-4-20250514
  permission_mode: acceptEdits
  session:
    timeout: 30m
    max_turns: 25
```

2. **Create examples/runtime-showcase/agents/sdk-agent.yaml** (Development setup):
```yaml
# Development Agent (SDK Runtime)
# Simplest setup - just needs ANTHROPIC_API_KEY
name: sdk-developer

description: |
  Development agent using SDK runtime.
  Best for: Local development, API-only deployments.

runtime: sdk  # Default, can be omitted

max_turns: 20
default_prompt: "Review the codebase and suggest improvements."

system_prompt: |
  You are a code reviewer. Analyze code for:
  - Code quality and best practices
  - Potential bugs or issues
  - Performance improvements

permissions:
  mode: acceptEdits
  allowed_tools:
    - Read
    - Glob
    - Grep
```

3. **Create examples/runtime-showcase/agents/cli-agent.yaml** (Cost-optimized):
```yaml
# Cost-Optimized Agent (CLI Runtime)
# Uses Claude CLI for Max plan pricing
name: cli-coder

description: |
  CLI runtime agent for Max plan users.
  Requires: Claude CLI installed and logged in (claude login).

runtime: cli  # Uses Max plan pricing if subscribed

max_turns: 50
default_prompt: "Check for issues and implement the oldest one."

system_prompt: |
  You are a software engineer implementing features.
  Follow existing code patterns and write tests.

permissions:
  mode: acceptEdits
  allowed_tools:
    - Read
    - Write
    - Edit
    - Bash
    - Glob
    - Grep
```

4. **Create examples/runtime-showcase/agents/docker-agent.yaml** (Production/Security):
```yaml
# Production Agent (Docker Runtime)
# Maximum security isolation with resource limits
name: docker-secure

description: |
  Production agent with Docker security isolation.
  Runs in container with restricted capabilities.

runtime: cli  # Can use sdk or cli inside Docker

# Docker security hardening
docker:
  enabled: true
  image: "anthropic/claude-code:latest"

  # Network: bridge (default) allows outbound; none for isolation
  network: bridge

  # Resource limits
  memory: "2g"
  cpu_shares: 1024

  # Security: runs as non-root, matches host user
  user: "1000:1000"

  # Workspace: read-write for code changes
  workspace_mode: rw

  # Additional mounts (optional)
  volumes:
    - "/shared/data:/data:ro"

  # Fresh container per job (recommended for production)
  ephemeral: true

max_turns: 100
default_prompt: "Process the next task from the queue."

system_prompt: |
  You are a production deployment agent.
  Follow security best practices.
  Never expose credentials in output.

permissions:
  mode: acceptEdits
  allowed_tools:
    - Read
    - Write
    - Edit
    - Bash
    - Glob
    - Grep
  bash:
    denied_patterns:
      - "sudo *"
      - "rm -rf /"
```

5. **Create examples/runtime-showcase/agents/mixed-fleet.yaml** (Mixed use cases):
```yaml
# Mixed Fleet Agent
# Shows how to use different configurations for different tasks
name: mixed-fleet

description: |
  Agent demonstrating multiple runtime strategies:
  - Development schedule: SDK (fast iteration)
  - Production schedule: Docker (security)

# Default runtime for this agent
runtime: sdk

# Development schedule (SDK, no Docker)
schedules:
  dev-check:
    type: interval
    interval: 5m
    prompt: "Check for local changes and run tests."
    # Inherits runtime: sdk from agent level

  # Production deployment would use Docker
  # (configured via agent overrides in herdctl.yaml)

# Anti-pattern examples (commented, showing what NOT to do):
#
# BAD: Missing auth mount when using Docker
# docker:
#   enabled: true
#   volumes: []  # No auth = Claude can't authenticate!
#
# BAD: No network with API-dependent agent
# docker:
#   enabled: true
#   network: none  # Can't reach APIs!
#
# BAD: Read-only workspace for coding agent
# docker:
#   enabled: true
#   workspace_mode: ro  # Can't write code changes!

max_turns: 30
default_prompt: "Run the development workflow."

permissions:
  mode: acceptEdits
  allowed_tools:
    - Read
    - Write
    - Bash
    - Glob
    - Grep
```
  </action>
  <verify>ls -la examples/runtime-showcase/agents/*.yaml | wc -l returns 4 or more, and grep -l "docker:" examples/runtime-showcase/agents/*.yaml returns at least one file</verify>
  <done>Runtime showcase examples created with SDK, CLI, Docker, and mixed fleet configurations</done>
</task>

<task type="auto">
  <name>Task 2: Create Runtime Troubleshooting Guide</name>
  <files>docs/src/content/docs/guides/runtime-troubleshooting.md</files>
  <action>
Create comprehensive troubleshooting guide at `docs/src/content/docs/guides/runtime-troubleshooting.md`.

Include:
1. **Starlight frontmatter**:
```
---
title: Runtime Troubleshooting
description: Diagnose and fix common runtime and Docker issues
---
```

2. **CLI Runtime Issues section**:

### CLI Runtime Issues

#### "claude: command not found"
**Cause**: Claude CLI not installed or not in PATH.
**Solution**:
```bash
npm install -g @anthropic-ai/claude-code
claude --version  # Verify installation
```

#### "Not logged in" or authentication errors
**Cause**: Claude CLI session expired or never logged in.
**Solution**:
```bash
claude login
# Follow prompts to authenticate
```

#### CLI sessions not appearing
**Cause**: Session files are managed by Claude CLI, not herdctl.
**Context**: CLI sessions are stored in `~/.claude/` (not `.herdctl/`).
**Note**: This is expected behavior - CLI and SDK sessions are kept separate.

3. **Docker Issues section**:

### Docker Issues

#### "Cannot connect to Docker daemon"
**Cause**: Docker not running or permission issues.
**Solution**:
```bash
# Check Docker is running
docker info

# On Linux, ensure user is in docker group
sudo usermod -aG docker $USER
# Then log out and back in
```

#### Container exits immediately
**Cause**: Usually missing auth files or wrong image.
**Solution**:
1. Check auth files exist: `ls ~/.claude/`
2. Verify image exists: `docker pull anthropic/claude-code:latest`
3. Check container logs: `docker logs <container-id>`

#### "Permission denied" inside container
**Cause**: UID/GID mismatch between host and container.
**Solution**:
```yaml
docker:
  enabled: true
  user: "1000:1000"  # Match your host user (run `id` to check)
```

#### Network issues (can't reach APIs)
**Cause**: Wrong network mode configured.
**Solution**:
```yaml
docker:
  enabled: true
  network: bridge  # Use 'bridge' (default) for network access
  # network: none   # DON'T use for agents needing internet
```

#### Container out of memory
**Cause**: Memory limit too low for task.
**Solution**:
```yaml
docker:
  enabled: true
  memory: "4g"  # Increase from default 2g
```

4. **Path Resolution Issues section**:

### Path Resolution Issues

#### Files not found inside container
**Cause**: Host paths don't exist inside container.
**Context**: Container has different filesystem. Workspace is mounted at same path, but other host paths aren't.
**Solution**: Use `volumes` to mount needed paths:
```yaml
docker:
  enabled: true
  volumes:
    - "/host/data:/data:ro"  # Now accessible as /data in container
```

#### Docker sessions not persisting
**Cause**: Docker sessions stored separately from host sessions.
**Context**: Docker sessions go to `.herdctl/docker-sessions/`, not `.herdctl/sessions/`. This prevents path confusion.
**Solution**: This is expected behavior. Don't try to share sessions between Docker and host execution.

5. **Common Anti-Patterns section**:

### Common Anti-Patterns

#### Missing auth files
```yaml
# BAD - No auth mount
docker:
  enabled: true
  volumes: []  # Claude can't authenticate!

# GOOD - Auth is auto-mounted (default behavior)
docker:
  enabled: true
  # Auth files mounted automatically at ~/.claude/
```

#### Network isolation with API agents
```yaml
# BAD - No network but agent needs APIs
docker:
  enabled: true
  network: none  # Agent can't reach GitHub, npm, etc.

# GOOD - Bridge for network access
docker:
  enabled: true
  network: bridge
```

#### Read-only workspace for coding agents
```yaml
# BAD - Can't write code
docker:
  enabled: true
  workspace_mode: ro  # Agent can't create/edit files!

# GOOD - Read-write for coding
docker:
  enabled: true
  workspace_mode: rw  # Default, can be omitted
```

#### Insufficient memory for complex tasks
```yaml
# BAD - May OOM on large codebases
docker:
  enabled: true
  memory: "512m"  # Too small!

# GOOD - Adequate memory
docker:
  enabled: true
  memory: "2g"  # Default, increase if needed
```

6. **Example Reference section** at end:
```markdown
## Working Examples

See the [runtime-showcase examples](https://github.com/edspencer/herdctl/tree/main/examples/runtime-showcase) for complete, tested configurations:

- `sdk-agent.yaml` - Development setup (SDK runtime)
- `cli-agent.yaml` - Cost-optimized setup (CLI runtime)
- `docker-agent.yaml` - Production setup (Docker isolation)
- `mixed-fleet.yaml` - Multiple runtime strategies

These examples are runnable without modification.
```
  </action>
  <verify>File exists at docs/src/content/docs/guides/runtime-troubleshooting.md with "Docker Issues", "CLI Runtime Issues", and "Anti-Patterns" sections</verify>
  <done>Troubleshooting guide created with CLI issues, Docker issues, path resolution, and anti-patterns</done>
</task>

</tasks>

<verification>
1. Example files exist:
   - examples/runtime-showcase/herdctl.yaml
   - examples/runtime-showcase/agents/sdk-agent.yaml
   - examples/runtime-showcase/agents/cli-agent.yaml
   - examples/runtime-showcase/agents/docker-agent.yaml
   - examples/runtime-showcase/agents/mixed-fleet.yaml

2. Troubleshooting guide exists:
   - docs/src/content/docs/guides/runtime-troubleshooting.md

3. Content completeness:
   - Examples cover all 4 use cases (dev, cost-optimized, production, mixed)
   - Troubleshooting has CLI, Docker, and path sections
   - Anti-patterns documented with correct alternatives
</verification>

<success_criteria>
- Example configs are copy-pastable and syntactically valid YAML
- Troubleshooting guide covers CLI runtime, Docker, and path resolution issues
- Anti-patterns show what NOT to do with corrections
- Cross-references between docs and examples
</success_criteria>

<output>
After completion, create `.planning/phases/04-documentation-and-testing/04-02-SUMMARY.md`
</output>
